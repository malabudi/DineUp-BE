name: CI

on: [push, pull_request]

env:
  JAVA_VERSION: 21
  JAVA_DISTRIBUTION: 'corretto'
  INTEGRATION_TEST_PATH: 'com.malabudi.dineupbe.journey.**'

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: > 
          mvn --batch-mode org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
          -Dsonar.region=us \
          -Dsonar.projectKey=dineup \
          -Dsonar.organization=dineup \
          -Dmaven.test.skip=true \
          -DskipTests \
          -DskipITs

  unit-tests:
    runs-on: ubuntu-latest
    needs: sonarqube
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      # To be removed once Test Containers resolves their issue
      # https://stackoverflow.com/questions/79817033/sudden-docker-error-about-client-api-version
      - name: Declare Docker API Version
        run: echo "api.version=1.44" >> ~/.docker-java.properties

      - name: Run Unit Tests
        run: mvn --batch-mode clean test

  integration-tests:
    runs-on: ubuntu-latest
    needs: sonarqube
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      # To be removed once Test Containers resolves their issue
      # https://stackoverflow.com/questions/79817033/sudden-docker-error-about-client-api-version
      - name: Declare Docker API Version
        run: echo "api.version=1.44" >> ~/.docker-java.properties

      - name: Run Integration Tests
        run: mvn --batch-mode clean test -Dtest="${{ env.INTEGRATION_TEST_PATH }}"
